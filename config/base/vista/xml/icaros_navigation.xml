<!-- 
SPDX-FileCopyrightText: German Aerospace Center (DLR) <cosmoscout@dlr.de>
SPDX-License-Identifier: MIT
This data flow net graph defines the interaction configuration for the ICAROS device. 
-->
<?xml version="1.0" encoding="utf-8"?>
<module>
    <nodespace></nodespace>
    <graph>

        <!-- time input -->
        <node name="timer" type="Timer" />
        <!-- icaros device input -->
        
        <node name="icaros" type="DriverSensor">
            <param name="sensor_index" value="0" />
            <param name="driver" value="ICAROS" />
        </node>

        <node name="history" type="HistoryProject">
            <param name="project">ORIENTATION, BUTTON_1, BUTTON_2, BUTTON_3, BUTTON_4</param>
        </node>

        <node name="sampling_mode" type="ConstantValue[int]">
            <param name="value" value="0" />
        </node>

        <!-- observer output -->
        <node name="observer" type="ObserverNavigationNode">
            <param name="max_linear_speed" value="10, 10, 10" />
            <param name="max_angular_speed" value="2" />
            <param name="angular_deceleration" value="1" />
            <param name="linear_acceleration" value="3" />
            <param name="linear_deceleration" value="1" />
            <param name="prevent_navigation_when_hovered_gui" value="false" />
        </node>

        <!-- movement -->

        <node name="movement" type="Compose3DVector" />
        <node name="down_movement" type="Multiply[float]"/>
        <node name="value_down_movement" type="ConstantValue[float]">
            <param name="value" value="-0.05" />
        </node>

        <!-- rotation -->
        <node name="orientation_invert" type="Invert[VistaQuaternion]"/>
        <node name="deconstruct" type="DecomposeQuaternion"/>

        <node name="yaw_rotation" type="AxisRotate"/>
        <node name="yaw" type="Multiply[float]"/>

        <node name="roll_angles_value" type="ConstantValue[float]">
            <param name="value" value="1.0" />
        </node>

         <node name="yaw_axis" type="ConstantValue[VistaVector3D]">
            <param name="value" value="0,1,0,0" />
        </node>

        <!-- bool to float -->
       
         <node name="zero" type="ConstantValue[float]">
            <param name="value" value="0"/>
        </node>
        <!-- debug text -->
        <node name="debug_text" type="SimpleText"/>
        

        <!-- bevor ich das mache nen Offset Substact oder Addtion node um sie auf 0 zu schieben.  mit dem wert direkt von deconstruct -->
        <node name="calibrate" type="Substract[float]"/>

        <node name="roll_absolute" type="Absolute[float]"/>
        <node name="roll_limited" type="Threshold[float]"/>
        
        <node name="roll_bool" type="LessEqual[float]"/> <!-- größer als 0 == false - kleiner als 0 == True --> 
        <node name="roll_sign_invert_bool" type="Invert[bool]"/>
        <node name="roll_sign_null_one" type="TypeConvert[bool,float]"/> <!--  0 bei unter 0          1 bei über 0 ==--> 
        <node name="roll_sign_multiply" type="Multiply[float]"/>  <!--  first = roll_sign_null_one             second = 2 --> 
        <node name="roll_sign" type="Substract[float]"/>  <!--  first = roll_sign_multiply             second = 1 --> 

        <node name="roll" type="Mulitply[float]"/>     <!-- first = roll_limited    second = roll_sign  DIESER WERT WIRD DANN MIT ROLL ANGLE -->  
        <node name="roll_angle" type="Mulitply[float]"/>
    </graph>
    <edges>

        <edge fromnode="icaros" tonode="history" fromport="history" toport="history" />
        <edge fromnode="sampling_mode" tonode="history" fromport="value" toport="sampling_mode" />
        <edge fromnode="history" tonode="debug_text" fromport="ORIENTATION"  toport="in_1" />
        <edge fromnode="history" tonode="orientation_invert" fromport="ORIENTATION" toport="in" />

        <edge fromnode="orientation_invert" tonode="deconstruct" fromport="out" toport="in" />

        <edge fromnode="deconstruct" tonode="down_movement" fromport="x"  toport="first" />
        <edge fromnode="value_down_movement" tonode="down_movement" fromport="value"  toport="second" />

        <edge fromnode="down_movement" tonode="movement" fromport="out"  toport="y" />
        <edge fromnode="zero" tonode="movement" fromport="value" toport="x" />
        <edge fromnode="zero" tonode="movement" fromport="value" toport="z" />


        <edge fromnode="deconstruct" tonode="yaw" fromport="y" toport="first" />
        <edge fromnode="roll_angles" tonode="yaw" fromport="value" toport="second" />

        <edge fromnode="yaw" tonode="debug_text" fromport="out"  toport="in_yaw" />

        <edge fromnode="yaw" tonode="yaw_rotation" fromport="out" toport="angle" />
        <edge fromnode="yaw_axis" tonode="yaw_rotation" fromport="value" toport="axis" />

        <edge fromnode="yaw_rotation" tonode="observer" fromport="out" toport="rotation" />
        <edge fromnode="movement" tonode="observer" fromport="out" toport="translation" />
        <edge fromnode="timer" tonode="observer" fromport="time" toport="time" />


    </edges>
    
</module>
